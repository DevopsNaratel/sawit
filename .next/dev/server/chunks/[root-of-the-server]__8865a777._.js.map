{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Git/Naratel-Devops-Dashboard/src/app/api/manifest/generate/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { execSync } from 'child_process';\nimport fs from 'fs';\nimport path from 'path';\nimport os from 'os';\n\nexport async function POST(req) {\n  const data = await req.json();\n  \n  // Cloud-Native Path: Use OS temp dir or a specific app folder\n  // In Docker/K8s, this will be inside the container ephemeral storage\n  const repoDirName = 'manifest-repo-workdir';\n  const repoPath = path.join(os.tmpdir(), repoDirName);\n  \n  const token = process.env.GITHUB_TOKEN;\n  const repoUrl = process.env.MANIFEST_REPO_URL;\n  const userName = process.env.GIT_USER_NAME || \"Naratel DevOps Dashboard\";\n  const userEmail = process.env.GIT_USER_EMAIL || \"devops@naratel.com\";\n\n  if (!repoUrl || !token) {\n      return NextResponse.json({ error: \"Configuration Error: MANIFEST_REPO_URL or GITHUB_TOKEN is missing.\" }, { status: 500 });\n  }\n\n  // Helper to mask token in logs\n  const maskToken = (url) => url.replace(token, '*****');\n\n  try {\n      // 0. Setup Repository (Clone or Pull)\n      const authenticatedUrl = repoUrl.replace(\"https://\", `https://${token}@`);\n\n      if (!fs.existsSync(repoPath)) {\n          console.log(`Cloning repository to ${repoPath}...`);\n          // Clone if doesn't exist\n          execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n          \n          // Set Identity after clone\n          execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n          execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n      } else {\n          console.log(`Updating repository at ${repoPath}...`);\n          // Pull if exists (reset to origin/main to avoid conflicts from previous messy runs)\n          try {\n             // Reset hard to ensure clean state matching remote\n             execSync(`git fetch origin`, { cwd: repoPath });\n             execSync(`git reset --hard origin/main`, { cwd: repoPath });\n          } catch (e) {\n             console.warn(\"Git pull/reset failed, attempting to re-clone...\", e.message);\n             fs.rmSync(repoPath, { recursive: true, force: true });\n             execSync(`git clone ${authenticatedUrl} ${repoPath}`);\n             execSync(`git config user.name \"${userName}\"`, { cwd: repoPath });\n             execSync(`git config user.email \"${userEmail}\"`, { cwd: repoPath });\n          }\n      }\n\n  } catch (error) {\n      console.error(\"Git Setup Failed:\", error.message);\n      return NextResponse.json({ error: \"Failed to initialize git repository: \" + error.message }, { status: 500 });\n  }\n\n  const generatedFolders = [];\n  const errors = [];\n\n  // Helper to create manifest\n  const createManifest = (folderName, env, config, type = 'app') => {\n    const targetFolder = path.join(repoPath, 'apps', folderName);\n    const filePath = path.join(targetFolder, 'values.yaml');\n\n    if (fs.existsSync(targetFolder)) {\n      errors.push(`Folder ${folderName} already exists!`);\n      return;\n    }\n\n    fs.mkdirSync(targetFolder, { recursive: true });\n\n    // Construct Secret Data\n    const secretDataObj = {};\n    \n    // Add custom user secrets\n    if (data.secrets && Array.isArray(data.secrets)) {\n        data.secrets.forEach(s => {\n            if(s.key && s.value) secretDataObj[s.key] = s.value;\n        });\n    }\n\n    // Add DB secrets if applicable\n    if (data.useDb) {\n        secretDataObj[\"DB_HOST\"] = `svc-${data.appName}-db-${data.nextId}`; // Assumes svc name convention\n        secretDataObj[\"DB_PORT\"] = \"5432\";\n        secretDataObj[\"DB_USER\"] = \"postgres\";\n        secretDataObj[\"DB_PASSWORD\"] = data.dbPassword;\n        secretDataObj[\"DB_NAME\"] = data.dbName;\n    }\n\n    secretDataObj[\"PORT\"] = config.targetPort?.toString() || \"3000\";\n\n    // Convert secret obj to YAML string lines\n    const secretDataYaml = Object.entries(secretDataObj)\n        .map(([k, v]) => `  ${k}: \"${v}\"`)\n        .join('\\n');\n\n    let yamlContent = \"\";\n\n    if (type === 'app') {\n        yamlContent = `\nnamespace: ${env}\ncontrollerType: Deployment\napp:\n  id: \"${data.nextId}\"\n  name: \"${config.name}\"\n  env: \"${env}\"\nimage:\n  repository: \"${config.imageRepo}\"\n  tag: \"${config.imageTag}\"\nservice:\n  port: ${config.port}\n  targetPort: ${config.targetPort}\nsecretData:\n${secretDataYaml}\n`.trim();\n    } else if (type === 'db') {\n        // DB Manifest Template (Simplified based on assumption)\n        yamlContent = `\nnamespace: ${env}\ncontrollerType: StatefulSet\napp:\n  id: \"${data.nextId}\"\n  name: \"${data.appName}-db\"\n  env: \"${env}\"\nimage:\n  repository: \"postgres\"\n  tag: \"15-alpine\"\nservice:\n  port: 5432\n  targetPort: 5432\nsecretData:\n  POSTGRES_DB: \"${data.dbName}\"\n  POSTGRES_USER: \"postgres\"\n  POSTGRES_PASSWORD: \"${data.dbPassword}\"\n`.trim();\n    }\n\n    fs.writeFileSync(filePath, yamlContent);\n\n    // Encrypt\n    try {\n        execSync(`sops --encrypt --age ${process.env.SOPS_AGE_PUBKEY} --encrypted-regex '^(secretData)$' --in-place ${filePath}`, { cwd: repoPath });\n        generatedFolders.push(folderName);\n    } catch (e) {\n        errors.push(`Encryption failed for ${folderName}: ${e.message}`);\n    }\n  };\n\n  try {\n    const envs = ['testing', 'prod'];\n\n    // 1. Generate App Manifests\n    if (data.isMicroservice && data.microservices?.length > 0) {\n        // Microservices Mode\n        for (const svc of data.microservices) {\n            for (const env of envs) {\n                const folderName = `${data.appName}-${svc.name}-${env}`;\n                createManifest(folderName, env, {\n                    name: `${data.appName}-${svc.name}`,\n                    imageRepo: svc.imageRepo,\n                    imageTag: svc.imageTag,\n                    port: svc.port,\n                    targetPort: svc.targetPort\n                }, 'app');\n            }\n        }\n    } else {\n        // Monolith Mode\n        for (const env of envs) {\n            const folderName = `${data.appName}-${env}`;\n            createManifest(folderName, env, {\n                name: data.appName,\n                imageRepo: data.imageRepo,\n                imageTag: data.imageTag,\n                port: data.port,\n                targetPort: data.targetPort\n            }, 'app');\n        }\n    }\n\n    // 2. Generate DB Manifests (if enabled)\n    if (data.useDb) {\n        for (const env of envs) {\n            const folderName = `${data.appName}-db-${env}`;\n            createManifest(folderName, env, {}, 'db');\n        }\n    }\n\n    if (errors.length > 0) {\n        // If there were errors but some folders were created, we might want to clean up or just report partial success.\n        // For now, fail if any error occurred.\n        return NextResponse.json({ error: errors.join(', '), generated: generatedFolders }, { status: 400 });\n    }\n\n    if (generatedFolders.length === 0) {\n        return NextResponse.json({ error: \"No manifests were generated.\" }, { status: 400 });\n    }\n\n    // 3. Git Automation\n    try {\n        const commitMsg = `feat: add manifests for ${data.appName} (${generatedFolders.length} items) ID: ${data.nextId}`;\n        \n        // Execute git commands\n        // Ensure we are adding ONLY the new files to avoid adding random temp files\n        execSync(`git add .`, { cwd: repoPath });\n        execSync(`git commit -m \"${commitMsg}\"`, { cwd: repoPath });\n        execSync(`git push origin main`, { cwd: repoPath });\n\n        return NextResponse.json({ \n            message: `Success! Generated ${generatedFolders.length} manifests and pushed to Git: ${generatedFolders.join(', ')}`,\n            folders: generatedFolders\n        });\n    } catch (gitError) {\n        console.error(\"Git automation failed:\", gitError);\n        return NextResponse.json({ \n            error: `Manifests generated but Git push failed: ${gitError.message}`,\n            generated: generatedFolders \n        }, { status: 500 });\n    }\n\n  } catch (error) {\n    console.error(error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,eAAe,KAAK,GAAG;IAC5B,MAAM,OAAO,MAAM,IAAI,IAAI;IAE3B,8DAA8D;IAC9D,qEAAqE;IACrE,MAAM,cAAc;IACpB,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,wGAAE,CAAC,MAAM,IAAI;IAExC,MAAM,QAAQ,QAAQ,GAAG,CAAC,YAAY;IACtC,MAAM,UAAU,QAAQ,GAAG,CAAC,iBAAiB;IAC7C,MAAM,WAAW,QAAQ,GAAG,CAAC,aAAa,IAAI;IAC9C,MAAM,YAAY,QAAQ,GAAG,CAAC,cAAc,IAAI;IAEhD,IAAI,CAAC,WAAW,CAAC,OAAO;QACpB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAqE,GAAG;YAAE,QAAQ;QAAI;IAC5H;IAEA,+BAA+B;IAC/B,MAAM,YAAY,CAAC,MAAQ,IAAI,OAAO,CAAC,OAAO;IAE9C,IAAI;QACA,sCAAsC;QACtC,MAAM,mBAAmB,QAAQ,OAAO,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;QAExE,IAAI,CAAC,wGAAE,CAAC,UAAU,CAAC,WAAW;YAC1B,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,SAAS,GAAG,CAAC;YAClD,yBAAyB;YACzB,IAAA,+HAAQ,EAAC,CAAC,UAAU,EAAE,iBAAiB,CAAC,EAAE,UAAU;YAEpD,2BAA2B;YAC3B,IAAA,+HAAQ,EAAC,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC,EAAE;gBAAE,KAAK;YAAS;YAC/D,IAAA,+HAAQ,EAAC,CAAC,uBAAuB,EAAE,UAAU,CAAC,CAAC,EAAE;gBAAE,KAAK;YAAS;QACrE,OAAO;YACH,QAAQ,GAAG,CAAC,CAAC,uBAAuB,EAAE,SAAS,GAAG,CAAC;YACnD,oFAAoF;YACpF,IAAI;gBACD,mDAAmD;gBACnD,IAAA,+HAAQ,EAAC,CAAC,gBAAgB,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBAC7C,IAAA,+HAAQ,EAAC,CAAC,4BAA4B,CAAC,EAAE;oBAAE,KAAK;gBAAS;YAC5D,EAAE,OAAO,GAAG;gBACT,QAAQ,IAAI,CAAC,oDAAoD,EAAE,OAAO;gBAC1E,wGAAE,CAAC,MAAM,CAAC,UAAU;oBAAE,WAAW;oBAAM,OAAO;gBAAK;gBACnD,IAAA,+HAAQ,EAAC,CAAC,UAAU,EAAE,iBAAiB,CAAC,EAAE,UAAU;gBACpD,IAAA,+HAAQ,EAAC,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC,EAAE;oBAAE,KAAK;gBAAS;gBAC/D,IAAA,+HAAQ,EAAC,CAAC,uBAAuB,EAAE,UAAU,CAAC,CAAC,EAAE;oBAAE,KAAK;gBAAS;YACpE;QACJ;IAEJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB,MAAM,OAAO;QAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,0CAA0C,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IAC/G;IAEA,MAAM,mBAAmB,EAAE;IAC3B,MAAM,SAAS,EAAE;IAEjB,4BAA4B;IAC5B,MAAM,iBAAiB,CAAC,YAAY,KAAK,QAAQ,OAAO,KAAK;QAC3D,MAAM,eAAe,4GAAI,CAAC,IAAI,CAAC,UAAU,QAAQ;QACjD,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,cAAc;QAEzC,IAAI,wGAAE,CAAC,UAAU,CAAC,eAAe;YAC/B,OAAO,IAAI,CAAC,CAAC,OAAO,EAAE,WAAW,gBAAgB,CAAC;YAClD;QACF;QAEA,wGAAE,CAAC,SAAS,CAAC,cAAc;YAAE,WAAW;QAAK;QAE7C,wBAAwB;QACxB,MAAM,gBAAgB,CAAC;QAEvB,0BAA0B;QAC1B,IAAI,KAAK,OAAO,IAAI,MAAM,OAAO,CAAC,KAAK,OAAO,GAAG;YAC7C,KAAK,OAAO,CAAC,OAAO,CAAC,CAAA;gBACjB,IAAG,EAAE,GAAG,IAAI,EAAE,KAAK,EAAE,aAAa,CAAC,EAAE,GAAG,CAAC,GAAG,EAAE,KAAK;YACvD;QACJ;QAEA,+BAA+B;QAC/B,IAAI,KAAK,KAAK,EAAE;YACZ,aAAa,CAAC,UAAU,GAAG,CAAC,IAAI,EAAE,KAAK,OAAO,CAAC,IAAI,EAAE,KAAK,MAAM,EAAE,EAAE,8BAA8B;YAClG,aAAa,CAAC,UAAU,GAAG;YAC3B,aAAa,CAAC,UAAU,GAAG;YAC3B,aAAa,CAAC,cAAc,GAAG,KAAK,UAAU;YAC9C,aAAa,CAAC,UAAU,GAAG,KAAK,MAAM;QAC1C;QAEA,aAAa,CAAC,OAAO,GAAG,OAAO,UAAU,EAAE,cAAc;QAEzD,0CAA0C;QAC1C,MAAM,iBAAiB,OAAO,OAAO,CAAC,eACjC,GAAG,CAAC,CAAC,CAAC,GAAG,EAAE,GAAK,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,CAAC,CAAC,EAChC,IAAI,CAAC;QAEV,IAAI,cAAc;QAElB,IAAI,SAAS,OAAO;YAChB,cAAc,CAAC;WACZ,EAAE,IAAI;;;OAGV,EAAE,KAAK,MAAM,CAAC;SACZ,EAAE,OAAO,IAAI,CAAC;QACf,EAAE,IAAI;;eAEC,EAAE,OAAO,SAAS,CAAC;QAC1B,EAAE,OAAO,QAAQ,CAAC;;QAElB,EAAE,OAAO,IAAI,CAAC;cACR,EAAE,OAAO,UAAU,CAAC;;AAElC,EAAE,eAAe;AACjB,CAAC,CAAC,IAAI;QACF,OAAO,IAAI,SAAS,MAAM;YACtB,wDAAwD;YACxD,cAAc,CAAC;WACZ,EAAE,IAAI;;;OAGV,EAAE,KAAK,MAAM,CAAC;SACZ,EAAE,KAAK,OAAO,CAAC;QAChB,EAAE,IAAI;;;;;;;;gBAQE,EAAE,KAAK,MAAM,CAAC;;sBAER,EAAE,KAAK,UAAU,CAAC;AACxC,CAAC,CAAC,IAAI;QACF;QAEA,wGAAE,CAAC,aAAa,CAAC,UAAU;QAE3B,UAAU;QACV,IAAI;YACA,IAAA,+HAAQ,EAAC,CAAC,qBAAqB,EAAE,QAAQ,GAAG,CAAC,eAAe,CAAC,+CAA+C,EAAE,UAAU,EAAE;gBAAE,KAAK;YAAS;YAC1I,iBAAiB,IAAI,CAAC;QAC1B,EAAE,OAAO,GAAG;YACR,OAAO,IAAI,CAAC,CAAC,sBAAsB,EAAE,WAAW,EAAE,EAAE,EAAE,OAAO,EAAE;QACnE;IACF;IAEA,IAAI;QACF,MAAM,OAAO;YAAC;YAAW;SAAO;QAEhC,4BAA4B;QAC5B,IAAI,KAAK,cAAc,IAAI,KAAK,aAAa,EAAE,SAAS,GAAG;YACvD,qBAAqB;YACrB,KAAK,MAAM,OAAO,KAAK,aAAa,CAAE;gBAClC,KAAK,MAAM,OAAO,KAAM;oBACpB,MAAM,aAAa,GAAG,KAAK,OAAO,CAAC,CAAC,EAAE,IAAI,IAAI,CAAC,CAAC,EAAE,KAAK;oBACvD,eAAe,YAAY,KAAK;wBAC5B,MAAM,GAAG,KAAK,OAAO,CAAC,CAAC,EAAE,IAAI,IAAI,EAAE;wBACnC,WAAW,IAAI,SAAS;wBACxB,UAAU,IAAI,QAAQ;wBACtB,MAAM,IAAI,IAAI;wBACd,YAAY,IAAI,UAAU;oBAC9B,GAAG;gBACP;YACJ;QACJ,OAAO;YACH,gBAAgB;YAChB,KAAK,MAAM,OAAO,KAAM;gBACpB,MAAM,aAAa,GAAG,KAAK,OAAO,CAAC,CAAC,EAAE,KAAK;gBAC3C,eAAe,YAAY,KAAK;oBAC5B,MAAM,KAAK,OAAO;oBAClB,WAAW,KAAK,SAAS;oBACzB,UAAU,KAAK,QAAQ;oBACvB,MAAM,KAAK,IAAI;oBACf,YAAY,KAAK,UAAU;gBAC/B,GAAG;YACP;QACJ;QAEA,wCAAwC;QACxC,IAAI,KAAK,KAAK,EAAE;YACZ,KAAK,MAAM,OAAO,KAAM;gBACpB,MAAM,aAAa,GAAG,KAAK,OAAO,CAAC,IAAI,EAAE,KAAK;gBAC9C,eAAe,YAAY,KAAK,CAAC,GAAG;YACxC;QACJ;QAEA,IAAI,OAAO,MAAM,GAAG,GAAG;YACnB,gHAAgH;YAChH,uCAAuC;YACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,OAAO,IAAI,CAAC;gBAAO,WAAW;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtG;QAEA,IAAI,iBAAiB,MAAM,KAAK,GAAG;YAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA+B,GAAG;gBAAE,QAAQ;YAAI;QACtF;QAEA,oBAAoB;QACpB,IAAI;YACA,MAAM,YAAY,CAAC,wBAAwB,EAAE,KAAK,OAAO,CAAC,EAAE,EAAE,iBAAiB,MAAM,CAAC,YAAY,EAAE,KAAK,MAAM,EAAE;YAEjH,uBAAuB;YACvB,4EAA4E;YAC5E,IAAA,+HAAQ,EAAC,CAAC,SAAS,CAAC,EAAE;gBAAE,KAAK;YAAS;YACtC,IAAA,+HAAQ,EAAC,CAAC,eAAe,EAAE,UAAU,CAAC,CAAC,EAAE;gBAAE,KAAK;YAAS;YACzD,IAAA,+HAAQ,EAAC,CAAC,oBAAoB,CAAC,EAAE;gBAAE,KAAK;YAAS;YAEjD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB,SAAS,CAAC,mBAAmB,EAAE,iBAAiB,MAAM,CAAC,8BAA8B,EAAE,iBAAiB,IAAI,CAAC,OAAO;gBACpH,SAAS;YACb;QACJ,EAAE,OAAO,UAAU;YACf,QAAQ,KAAK,CAAC,0BAA0B;YACxC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACrB,OAAO,CAAC,yCAAyC,EAAE,SAAS,OAAO,EAAE;gBACrE,WAAW;YACf,GAAG;gBAAE,QAAQ;YAAI;QACrB;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}