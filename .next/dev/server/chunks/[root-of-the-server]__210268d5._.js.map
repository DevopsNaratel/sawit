{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 208, "column": 0}, "map": {"version":3,"sources":["file:///home/duwa/Code/Git/Naratel-Devops-Dashboard/src/app/api/k8s/secret/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport * as k8s from '@kubernetes/client-node';\n\n// ✅ GET method - untuk fetch secrets\nexport async function GET(request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const namespace = searchParams.get('namespace') || 'default';\n\n    const kc = new k8s.KubeConfig();\n    kc.loadFromOptions({\n      clusters: [{\n        name: 'remote-cluster',\n        server: process.env.K8S_API_URL,\n        skipTLSVerify: true,\n      }],\n      users: [{\n        name: 'dashboard-sa',\n        token: process.env.K8S_TOKEN,\n      }],\n      contexts: [{\n        name: 'remote-context',\n        user: 'dashboard-sa',\n        cluster: 'remote-cluster',\n      }],\n      currentContext: 'remote-context',\n    });\n\n    const k8sApi = kc.makeApiClient(k8s.CoreV1Api);\n    const res = await k8sApi.listNamespacedSecret(namespace);\n\n    const items = res.body?.items || res.items || [];\n    const secrets = items.map(secret => ({\n      name: secret.metadata.name,\n      type: secret.type,\n      dataKeys: Object.keys(secret.data || {})\n    }));\n\n    return NextResponse.json({\n      success: true,\n      secrets: secrets,\n      namespace: namespace\n    });\n\n  } catch (error) {\n    console.error('--- K8S SECRET GET ERROR ---');\n    console.error('Message:', error.message);\n    \n    return NextResponse.json({\n      success: false,\n      message: `Gagal fetch secrets: ${error.message}`\n    }, { status: 500 });\n  }\n}\n\n// ✅ POST method - untuk create/update secret\nexport async function POST(request) {\n  try {\n    const body = await request.json();\n    const { secretName, namespace, secretType, data } = body;\n\n    if (!secretName || !namespace || !data) {\n      return NextResponse.json({\n        success: false,\n        message: 'secretName, namespace, dan data diperlukan'\n      }, { status: 400 });\n    }\n\n    const kc = new k8s.KubeConfig();\n    kc.loadFromOptions({\n      clusters: [{\n        name: 'remote-cluster',\n        server: process.env.K8S_API_URL,\n        skipTLSVerify: true,\n      }],\n      users: [{\n        name: 'dashboard-sa',\n        token: process.env.K8S_TOKEN,\n      }],\n      contexts: [{\n        name: 'remote-context',\n        user: 'dashboard-sa',\n        cluster: 'remote-cluster',\n      }],\n      currentContext: 'remote-context',\n    });\n\n    const k8sApi = kc.makeApiClient(k8s.CoreV1Api);\n\n    // Encode data to base64\n    const encodedData = {};\n    Object.keys(data).forEach(key => {\n      encodedData[key] = Buffer.from(data[key]).toString('base64');\n    });\n\n    const secretManifest = {\n      apiVersion: 'v1',\n      kind: 'Secret',\n      metadata: {\n        name: secretName,\n        namespace: namespace\n      },\n      type: secretType || 'Opaque',\n      data: encodedData\n    };\n\n    try {\n      // Try to update existing secret\n      await k8sApi.replaceNamespacedSecret(\n        secretName,\n        namespace,\n        secretManifest\n      );\n\n      return NextResponse.json({\n        success: true,\n        message: `Secret \"${secretName}\" berhasil diupdate di namespace \"${namespace}\"`\n      });\n\n    } catch (error) {\n      // If secret doesn't exist, create new one\n      if (error.response?.statusCode === 404) {\n        await k8sApi.createNamespacedSecret(namespace, secretManifest);\n        \n        return NextResponse.json({\n          success: true,\n          message: `Secret \"${secretName}\" berhasil dibuat di namespace \"${namespace}\"`\n        });\n      }\n      throw error;\n    }\n\n  } catch (error) {\n    console.error('--- K8S SECRET POST ERROR ---');\n    console.error('Message:', error.message);\n    if (error.response) {\n      console.error('Status:', error.response.statusCode);\n      console.error('Body:', error.response.body);\n    }\n\n    return NextResponse.json({\n      success: false,\n      message: `Gagal membuat/update secret: ${error.message}`\n    }, { status: 500 });\n  }\n}\n\n// ✅ DELETE method (opsional - jika butuh fitur delete)\nexport async function DELETE(request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const secretName = searchParams.get('name');\n    const namespace = searchParams.get('namespace') || 'default';\n\n    if (!secretName) {\n      return NextResponse.json({\n        success: false,\n        message: 'Secret name diperlukan'\n      }, { status: 400 });\n    }\n\n    const kc = new k8s.KubeConfig();\n    kc.loadFromOptions({\n      clusters: [{\n        name: 'remote-cluster',\n        server: process.env.K8S_API_URL,\n        skipTLSVerify: true,\n      }],\n      users: [{\n        name: 'dashboard-sa',\n        token: process.env.K8S_TOKEN,\n      }],\n      contexts: [{\n        name: 'remote-context',\n        user: 'dashboard-sa',\n        cluster: 'remote-cluster',\n      }],\n      currentContext: 'remote-context',\n    });\n\n    const k8sApi = kc.makeApiClient(k8s.CoreV1Api);\n    await k8sApi.deleteNamespacedSecret(secretName, namespace);\n\n    return NextResponse.json({\n      success: true,\n      message: `Secret \"${secretName}\" berhasil dihapus dari namespace \"${namespace}\"`\n    });\n\n  } catch (error) {\n    console.error('--- K8S SECRET DELETE ERROR ---');\n    console.error('Message:', error.message);\n\n    return NextResponse.json({\n      success: false,\n      message: `Gagal menghapus secret: ${error.message}`\n    }, { status: 500 });\n  }\n}"],"names":[],"mappings":"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"}}]
}